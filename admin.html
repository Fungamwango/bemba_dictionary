<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Panel - Bemba Dictionary</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f5f5f5;color:#202124;}
.container{max-width:800px;margin:0 auto;padding:16px;}
h1{font-size:20px;margin-bottom:16px;color:#1a73e8;}

/* Login */
#login-section{max-width:360px;margin:80px auto;background:#fff;padding:32px 24px;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.1);}
#login-section h2{text-align:center;margin-bottom:20px;font-size:22px;}
#login-section input{width:100%;padding:12px;margin-bottom:12px;border:1.5px solid #dadce0;border-radius:8px;font-size:14px;outline:none;}
#login-section input:focus{border-color:#1a73e8;}
#login-section button{width:100%;padding:12px;background:#1a73e8;color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;}
#login-section button:hover{background:#1558b0;}
#login-error{color:#ea4335;font-size:13px;margin-top:8px;display:none;text-align:center;}

/* Admin panel */
#admin-panel{display:none;}
.top-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.top-bar .stats{font-size:13px;color:#5f6368;}
#logout-btn{padding:6px 14px;background:#ea4335;color:#fff;border:none;border-radius:6px;font-size:13px;cursor:pointer;}

/* Search */
#search-input{width:100%;padding:10px 14px;border:1.5px solid #dadce0;border-radius:8px;font-size:14px;margin-bottom:12px;outline:none;}
#search-input:focus{border-color:#1a73e8;}

/* Table */
.users-table{width:100%;background:#fff;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,0.08);overflow:hidden;}
.user-row{display:flex;align-items:center;padding:12px 14px;border-bottom:1px solid #e8e8e8;gap:10px;}
.user-row:last-child{border-bottom:none;}
.user-rank{width:30px;font-size:13px;color:#5f6368;font-weight:600;text-align:center;flex-shrink:0;}
.user-info{flex:1;min-width:0;}
.user-name{font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.user-meta{font-size:11px;color:#80868b;margin-top:2px;}
.user-points{font-size:14px;font-weight:600;color:#1a73e8;width:60px;text-align:right;flex-shrink:0;}
.user-actions{display:flex;gap:6px;flex-shrink:0;}
.btn-edit,.btn-del{padding:5px 10px;border:none;border-radius:6px;font-size:12px;cursor:pointer;font-weight:500;}
.btn-edit{background:#e8f0fe;color:#1a73e8;}
.btn-edit:hover{background:#d2e3fc;}
.btn-del{background:#fce8e6;color:#ea4335;}
.btn-del:hover{background:#f8d7da;}

/* Load more */
#load-more-wrap{text-align:center;margin:16px 0;}
#load-more-btn{padding:10px 24px;background:#fff;border:1.5px solid #dadce0;border-radius:8px;font-size:14px;cursor:pointer;color:#1a73e8;font-weight:500;}
#load-more-btn:hover{background:#f8f9fa;}

/* Edit modal */
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;}
.modal{background:#fff;border-radius:12px;padding:24px;max-width:360px;width:90%;box-shadow:0 4px 24px rgba(0,0,0,0.2);}
.modal h3{margin-bottom:16px;font-size:18px;}
.modal label{font-size:13px;color:#5f6368;display:block;margin-bottom:4px;margin-top:12px;}
.modal input{width:100%;padding:10px;border:1.5px solid #dadce0;border-radius:8px;font-size:14px;outline:none;}
.modal input:focus{border-color:#1a73e8;}
.modal-btns{display:flex;gap:8px;margin-top:20px;justify-content:flex-end;}
.modal-btns button{padding:8px 18px;border:none;border-radius:6px;font-size:14px;cursor:pointer;font-weight:500;}
.btn-save{background:#1a73e8;color:#fff;}
.btn-cancel{background:#f1f3f4;color:#5f6368;}

.loading{text-align:center;padding:20px;color:#80868b;}
.msg{text-align:center;padding:12px;margin:8px 0;border-radius:8px;font-size:13px;display:none;}
.msg-ok{background:#e6f4ea;color:#137333;}
.msg-err{background:#fce8e6;color:#ea4335;}

/* Tabs */
.tab-bar{display:flex;gap:0;margin-bottom:16px;border-bottom:2px solid #e8e8e8;}
.tab-btn{padding:10px 20px;background:none;border:none;font-size:14px;font-weight:600;color:#5f6368;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;}
.tab-btn.active{color:#1a73e8;border-bottom-color:#1a73e8;}
.tab-btn:hover{color:#1a73e8;background:#f8f9fa;}

/* Posts */
#posts-section{display:none;}
.post-row{padding:14px;border-bottom:1px solid #e8e8e8;}
.post-row:last-child{border-bottom:none;}
.post-author{font-size:12px;color:#5f6368;margin-bottom:4px;font-weight:600;}
.post-content{font-size:14px;color:#202124;margin-bottom:8px;line-height:1.4;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.post-meta{font-size:11px;color:#80868b;margin-bottom:8px;}
.post-btns{display:flex;gap:6px;}

/* Settings */
#settings-section{display:none;}

/* Stats */
#stats-section{display:none;}
.stats-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;}
.stat-card{background:#fff;border-radius:10px;padding:16px;text-align:center;box-shadow:0 1px 6px rgba(0,0,0,0.08);}
.stat-card-val{font-size:28px;font-weight:800;color:#1a73e8;}
.stat-card-lbl{font-size:12px;color:#80868b;margin-top:4px;}
.stat-card.online .stat-card-val{color:#34a853;}
.stat-card.money .stat-card-val{color:#f29900;}
.stats-section-title{font-size:13px;font-weight:600;color:#80868b;text-transform:uppercase;letter-spacing:0.5px;margin:16px 0 10px;}
.chart-wrap{background:#fff;border-radius:10px;padding:16px;box-shadow:0 1px 6px rgba(0,0,0,0.08);}
.chart-title{font-size:14px;font-weight:600;color:#202124;margin-bottom:14px;}
.bar-chart{display:flex;align-items:flex-end;gap:6px;height:120px;}
.bar-col{display:flex;flex-direction:column;align-items:center;flex:1;}
.bar{width:100%;background:#1a73e8;border-radius:4px 4px 0 0;min-height:2px;transition:height 0.3s;}
.bar-val{font-size:10px;color:#5f6368;margin-top:4px;}
.bar-day{font-size:10px;color:#80868b;margin-top:2px;}
.settings-card{background:#fff;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,0.08);padding:24px;max-width:480px;}
.settings-card label{font-size:13px;color:#5f6368;display:block;margin-bottom:4px;margin-top:16px;font-weight:500;}
.settings-card label:first-child{margin-top:0;}
.settings-card input{width:100%;padding:10px;border:1.5px solid #dadce0;border-radius:8px;font-size:14px;outline:none;}
.settings-card input:focus{border-color:#1a73e8;}
.settings-card .hint{font-size:11px;color:#80868b;margin-top:2px;}
#settings-save{margin-top:20px;padding:10px 28px;background:#1a73e8;color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;}
#settings-save:hover{background:#1558b0;}
#settings-save:disabled{background:#dadce0;cursor:default;}
#settings-status{font-size:13px;margin-top:10px;min-height:20px;}
</style>
</head>
<body>

<div id="login-section">
  <h2>Admin Login</h2>
  <input type="tel" id="login-phone" placeholder="Phone number">
  <input type="password" id="login-pass" placeholder="Password">
  <button id="login-btn">Login</button>
  <div id="login-error"></div>
</div>

<div id="admin-panel" class="container">
  <div class="top-bar">
    <h1>Admin Panel</h1>
    <div>
      <span class="stats" id="total-users"></span>
      <button id="logout-btn">Logout</button>
    </div>
  </div>
  <div id="msg" class="msg"></div>
  <div class="tab-bar">
    <button class="tab-btn active" id="tab-users">Users</button>
    <button class="tab-btn" id="tab-posts">Posts</button>
    <button class="tab-btn" id="tab-stats">Stats</button>
    <button class="tab-btn" id="tab-settings">Settings</button>
  </div>
  <div id="users-section">
    <input type="text" id="search-input" placeholder="Search users by name or code...">
    <div class="users-table" id="users-list"></div>
    <div id="load-more-wrap" style="display:none;">
      <button id="load-more-btn">Load More</button>
    </div>
  </div>
  <div id="posts-section" style="display:none;">
    <div class="users-table" id="posts-list"></div>
    <div id="posts-load-more-wrap" style="display:none;">
      <button id="posts-load-more-btn">Load More</button>
    </div>
  </div>
  <div id="stats-section">
    <div class="stats-section-title">Visitors</div>
    <div class="stats-cards">
      <div class="stat-card online"><div class="stat-card-val" id="stat-online">‚Äî</div><div class="stat-card-lbl">Online Now</div></div>
      <div class="stat-card"><div class="stat-card-val" id="stat-today">‚Äî</div><div class="stat-card-lbl">Visitors Today</div></div>
      <div class="stat-card"><div class="stat-card-val" id="stat-new">‚Äî</div><div class="stat-card-lbl">New Today</div></div>
    </div>
    <div class="stats-section-title">Subscriptions</div>
    <div class="stats-cards">
      <div class="stat-card money"><div class="stat-card-val" id="stat-paid-today">‚Äî</div><div class="stat-card-lbl">Paid Today</div></div>
      <div class="stat-card money"><div class="stat-card-val" id="stat-subscribed">‚Äî</div><div class="stat-card-lbl">Active Subscribers</div></div>
      <div class="stat-card money"><div class="stat-card-val" id="stat-earnings">‚Äî</div><div class="stat-card-lbl">Total Earnings</div></div>
    </div>
    <div class="chart-wrap">
      <div class="chart-title">Daily Visitors ‚Äî Last 7 Days</div>
      <div class="bar-chart" id="visitors-chart"></div>
    </div>
  </div>
  <div id="settings-section">
    <div class="settings-card">
      <h3 style="margin-bottom:4px;font-size:17px;">Subscription Settings</h3>
      <p style="font-size:12px;color:#80868b;margin-bottom:8px;">Changes take effect immediately for all users on next page load.</p>
      <label>Subscription Price</label>
      <input type="text" id="set-price" placeholder="e.g. K2">
      <div class="hint">Include currency symbol (e.g. K2, K5, K10)</div>
      <label>Subscription Duration (days)</label>
      <input type="number" id="set-days" min="1" placeholder="e.g. 4">
      <label>Free Word Limit (per day)</label>
      <input type="number" id="set-words" min="1" placeholder="e.g. 5">
      <label>Free Quiz Limit (per day)</label>
      <input type="number" id="set-quizzes" min="1" placeholder="e.g. 1">
      <label>Payment Number (Mobile Money)</label>
      <input type="tel" id="set-phone" placeholder="e.g. 0962464552">
      <button id="settings-save">Save Settings</button>
      <div id="settings-status"></div>
    </div>
  </div>
</div>

<script>
(function() {
  var API = '/api/admin';
  var token = sessionStorage.getItem('admin_token') || '';
  var offset = 0;
  var currentSearch = '';

  // Elements
  var loginSection = document.getElementById('login-section');
  var adminPanel = document.getElementById('admin-panel');
  var loginBtn = document.getElementById('login-btn');
  var logoutBtn = document.getElementById('logout-btn');
  var searchInput = document.getElementById('search-input');
  var usersList = document.getElementById('users-list');
  var loadMoreWrap = document.getElementById('load-more-wrap');
  var loadMoreBtn = document.getElementById('load-more-btn');
  var msgEl = document.getElementById('msg');
  var totalEl = document.getElementById('total-users');

  function api(endpoint, data, cb) {
    data.token = token;
    fetch(API + endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    }).then(function(r) { return r.json(); }).then(cb).catch(function(e) {
      cb({ ok: false, error: e.message });
    });
  }

  function showMsg(text, isError) {
    msgEl.textContent = text;
    msgEl.className = 'msg ' + (isError ? 'msg-err' : 'msg-ok');
    msgEl.style.display = 'block';
    setTimeout(function() { msgEl.style.display = 'none'; }, 3000);
  }

  function timeAgo(ts) {
    if (!ts) return 'never';
    var d = new Date(ts + 'Z');
    var diff = (Date.now() - d.getTime()) / 1000;
    if (diff < 60) return 'just now';
    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
    return Math.floor(diff / 86400) + 'd ago';
  }

  // Login
  loginBtn.addEventListener('click', function() {
    var phone = document.getElementById('login-phone').value.trim();
    var pass = document.getElementById('login-pass').value;
    if (!phone || !pass) return;
    loginBtn.textContent = 'Logging in...';
    loginBtn.disabled = true;

    fetch(API + '/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone: phone, password: pass })
    }).then(function(r) { return r.json(); }).then(function(resp) {
      loginBtn.textContent = 'Login';
      loginBtn.disabled = false;
      if (resp.ok) {
        token = resp.token;
        sessionStorage.setItem('admin_token', token);
        showPanel();
      } else {
        var errEl = document.getElementById('login-error');
        errEl.textContent = resp.error || 'Login failed';
        errEl.style.display = 'block';
        setTimeout(function() { errEl.style.display = 'none'; }, 3000);
      }
    }).catch(function() {
      loginBtn.textContent = 'Login';
      loginBtn.disabled = false;
    });
  });

  // Logout
  logoutBtn.addEventListener('click', function() {
    sessionStorage.removeItem('admin_token');
    token = '';
    adminPanel.style.display = 'none';
    loginSection.style.display = 'block';
  });

  // Show panel
  function showPanel() {
    loginSection.style.display = 'none';
    adminPanel.style.display = 'block';
    offset = 0;
    currentSearch = '';
    searchInput.value = '';
    loadUsers(false);
  }

  // Load users
  function loadUsers(append) {
    if (!append) {
      usersList.innerHTML = '<div class="loading">Loading...</div>';
      offset = 0;
    }
    api('/users', { offset: offset, search: currentSearch }, function(resp) {
      if (!resp.ok) {
        if (resp.error === 'Token expired' || resp.error === 'Invalid token') {
          sessionStorage.removeItem('admin_token');
          token = '';
          adminPanel.style.display = 'none';
          loginSection.style.display = 'block';
          return;
        }
        usersList.innerHTML = '<div class="loading">Error: ' + (resp.error || 'unknown') + '</div>';
        return;
      }

      totalEl.textContent = 'Total: ' + resp.total + ' users';

      if (!append) usersList.innerHTML = '';

      var users = resp.users;
      for (var i = 0; i < users.length; i++) {
        var u = users[i];
        var row = document.createElement('div');
        row.className = 'user-row';
        row.setAttribute('data-uid', u.id);
        row.innerHTML = '<span class="user-rank">' + (offset + i + 1) + '</span>'
          + '<div class="user-info">'
          + '<div class="user-name">' + escapeHtml(u.name) + '</div>'
          + '<div class="user-meta">' + escapeHtml(u.friend_code) + ' &middot; W:' + u.challenges_won + ' L:' + u.challenges_lost + ' D:' + u.challenges_drawn + ' &middot; ' + timeAgo(u.last_seen) + '</div>'
          + '</div>'
          + '<span class="user-points">' + u.points + 'pts</span>'
          + '<div class="user-actions">'
          + '<button class="btn-edit" data-id="' + u.id + '" data-name="' + escapeHtml(u.name) + '" data-pts="' + u.points + '">Edit</button>'
          + '<button class="btn-del" data-id="' + u.id + '" data-name="' + escapeHtml(u.name) + '">Del</button>'
          + '</div>';
        usersList.appendChild(row);
      }

      // Bind edit/delete
      var editBtns = usersList.querySelectorAll('.btn-edit');
      for (var e = 0; e < editBtns.length; e++) {
        editBtns[e].onclick = function() { openEdit(this); };
      }
      var delBtns = usersList.querySelectorAll('.btn-del');
      for (var d = 0; d < delBtns.length; d++) {
        delBtns[d].onclick = function() { deleteUser(this); };
      }

      loadMoreWrap.style.display = resp.has_more ? 'block' : 'none';
      offset += users.length;
    });
  }

  // Search (debounced)
  var searchTimer;
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(function() {
      currentSearch = searchInput.value.trim();
      offset = 0;
      loadUsers(false);
    }, 400);
  });

  // Load more
  loadMoreBtn.addEventListener('click', function() {
    loadUsers(true);
  });

  // Edit modal
  function openEdit(btn) {
    var uid = btn.getAttribute('data-id');
    var name = btn.getAttribute('data-name');
    var pts = btn.getAttribute('data-pts');

    var overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.innerHTML = '<div class="modal">'
      + '<h3>Edit User</h3>'
      + '<label>Name</label><input type="text" id="edit-name" value="' + escapeHtml(name) + '" maxlength="50">'
      + '<label>Points</label><input type="number" id="edit-pts" value="' + pts + '">'
      + '<div class="modal-btns"><button class="btn-cancel" id="edit-cancel">Cancel</button><button class="btn-save" id="edit-save">Save</button></div>'
      + '</div>';
    document.body.appendChild(overlay);

    overlay.addEventListener('click', function(e) { if (e.target === overlay) document.body.removeChild(overlay); });
    document.getElementById('edit-cancel').addEventListener('click', function() { document.body.removeChild(overlay); });
    document.getElementById('edit-save').addEventListener('click', function() {
      var newName = document.getElementById('edit-name').value.trim();
      var newPts = parseInt(document.getElementById('edit-pts').value) || 0;
      if (!newName) return;

      api('/useredit', { user_id: parseInt(uid), name: newName, points: newPts }, function(resp) {
        document.body.removeChild(overlay);
        if (resp.ok) {
          showMsg('User updated');
          offset = 0;
          loadUsers(false);
        } else {
          showMsg(resp.error || 'Update failed', true);
        }
      });
    });
  }

  // Delete user
  function deleteUser(btn) {
    var uid = btn.getAttribute('data-id');
    var name = btn.getAttribute('data-name');
    if (!confirm('Delete "' + name + '" and all their data? This cannot be undone.')) return;

    api('/userdelete', { user_id: parseInt(uid) }, function(resp) {
      if (resp.ok) {
        showMsg('Deleted: ' + resp.deleted);
        // Remove row
        var row = btn.closest('.user-row');
        if (row) { row.style.transition = 'opacity .3s'; row.style.opacity = '0'; setTimeout(function() { row.remove(); }, 300); }
      } else {
        showMsg(resp.error || 'Delete failed', true);
      }
    });
  }

  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  // --- Posts Management ---
  var postsOffset = 0;
  var postsLimit = 20;

  function loadPosts(append) {
    var postsList = document.getElementById('posts-list');
    var postsLoadMoreWrap = document.getElementById('posts-load-more-wrap');

    if (!append) {
      postsList.innerHTML = '<div class="loading">Loading posts...</div>';
      postsOffset = 0;
    }

    api('/posts', { offset: postsOffset, limit: postsLimit }, function(resp) {
      if (!resp.ok) {
        postsList.innerHTML = '<div class="loading">Error loading posts</div>';
        return;
      }

      if (!append) postsList.innerHTML = '';

      var posts = resp.posts || [];
      if (posts.length === 0 && postsOffset === 0) {
        postsList.innerHTML = '<div class="loading">No posts yet</div>';
        postsLoadMoreWrap.style.display = 'none';
        return;
      }

      for (var i = 0; i < posts.length; i++) {
        var p = posts[i];
        var truncatedContent = p.content.length > 30 ? p.content.substring(0, 30) + '...' : p.content;
        var row = document.createElement('div');
        row.className = 'post-row';
        row.innerHTML = '<div class="post-author">' + escapeHtml(p.user_name) + '</div>'
          + '<div class="post-content">' + escapeHtml(truncatedContent) + '</div>'
          + '<div class="post-meta">üëç ' + (p.likes_count || 0) + ' &middot; üí¨ ' + (p.comments_count || 0) + ' &middot; ' + timeAgo(p.created_at) + '</div>'
          + '<div class="post-btns">'
          + '<button class="btn-edit" data-id="' + p.id + '" data-content="' + escapeHtml(p.content) + '">Edit</button>'
          + '<button class="btn-del" data-id="' + p.id + '">Delete</button>'
          + '</div>';
        postsList.appendChild(row);
      }

      // Bind buttons
      var editBtns = postsList.querySelectorAll('.btn-edit');
      for (var e = 0; e < editBtns.length; e++) {
        editBtns[e].onclick = function() { openPostEdit(this); };
      }
      var delBtns = postsList.querySelectorAll('.btn-del');
      for (var d = 0; d < delBtns.length; d++) {
        delBtns[d].onclick = function() { deletePost(this); };
      }

      postsLoadMoreWrap.style.display = posts.length === postsLimit ? 'block' : 'none';
      postsOffset += posts.length;
    });
  }

  // Load more posts
  var postsLoadMoreBtn = document.getElementById('posts-load-more-btn');
  if (postsLoadMoreBtn) {
    postsLoadMoreBtn.addEventListener('click', function() {
      loadPosts(true);
    });
  }

  // Edit post
  function openPostEdit(btn) {
    var postId = btn.getAttribute('data-id');
    var content = btn.getAttribute('data-content');

    var overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.innerHTML = '<div class="modal">'
      + '<h3>Edit Post</h3>'
      + '<label>Content</label><textarea id="edit-post-content" style="width:100%;padding:10px;border:1.5px solid #dadce0;border-radius:8px;font-size:14px;min-height:100px;font-family:inherit;resize:vertical;" maxlength="500">' + escapeHtml(content) + '</textarea>'
      + '<div class="modal-btns"><button class="btn-cancel" id="post-edit-cancel">Cancel</button><button class="btn-save" id="post-edit-save">Save</button></div>'
      + '</div>';
    document.body.appendChild(overlay);

    overlay.addEventListener('click', function(e) { if (e.target === overlay) document.body.removeChild(overlay); });
    document.getElementById('post-edit-cancel').addEventListener('click', function() { document.body.removeChild(overlay); });
    document.getElementById('post-edit-save').addEventListener('click', function() {
      var newContent = document.getElementById('edit-post-content').value.trim();
      if (!newContent || newContent.length < 5) {
        alert('Content must be at least 5 characters');
        return;
      }

      api('/postedit', { post_id: parseInt(postId), content: newContent }, function(resp) {
        document.body.removeChild(overlay);
        if (resp.ok) {
          showMsg('Post updated');
          loadPosts(false);
        } else {
          showMsg(resp.error || 'Update failed', true);
        }
      });
    });
  }

  // Delete post
  function deletePost(btn) {
    var postId = btn.getAttribute('data-id');
    if (!confirm('Delete this post?')) return;

    api('/postdelete', { post_id: parseInt(postId) }, function(resp) {
      if (resp.ok) {
        showMsg('Post deleted');
        var row = btn.closest('.post-row');
        if (row) { row.style.transition = 'opacity .3s'; row.style.opacity = '0'; setTimeout(function() { row.remove(); }, 300); }
      } else {
        showMsg(resp.error || 'Delete failed', true);
      }
    });
  }

  // --- Tabs ---
  var tabUsers = document.getElementById('tab-users');
  var tabPosts = document.getElementById('tab-posts');
  var tabStats = document.getElementById('tab-stats');
  var tabSettings = document.getElementById('tab-settings');
  var usersSection = document.getElementById('users-section');
  var postsSection = document.getElementById('posts-section');
  var statsSection = document.getElementById('stats-section');
  var settingsSection = document.getElementById('settings-section');
  var statsRefreshTimer = null;

  function setActiveTab(active) {
    [tabUsers, tabPosts, tabStats, tabSettings].forEach(function(t) { t.classList.remove('active'); });
    active.classList.add('active');
    usersSection.style.display = 'none';
    postsSection.style.display = 'none';
    statsSection.style.display = 'none';
    settingsSection.style.display = 'none';
    clearInterval(statsRefreshTimer);
  }
  tabUsers.addEventListener('click', function() {
    setActiveTab(tabUsers);
    usersSection.style.display = 'block';
  });
  tabPosts.addEventListener('click', function() {
    setActiveTab(tabPosts);
    postsSection.style.display = 'block';
    loadPosts();
  });
  tabStats.addEventListener('click', function() {
    setActiveTab(tabStats);
    statsSection.style.display = 'block';
    loadStats();
    statsRefreshTimer = setInterval(loadStats, 30000);
  });
  tabSettings.addEventListener('click', function() {
    setActiveTab(tabSettings);
    settingsSection.style.display = 'block';
    loadSettings();
  });

  // --- Stats ---
  function loadStats() {
    api('/stats', {}, function(resp) {
      if (!resp.ok) return;
      document.getElementById('stat-online').textContent = resp.online_now;
      document.getElementById('stat-new').textContent = resp.new_today;
      // Today's visitors from daily_visitors array (last item)
      var daily = resp.daily_visitors || [];
      var todayCount = daily.length ? daily[daily.length - 1].count : 0;
      document.getElementById('stat-today').textContent = todayCount;
      // Subscription stats
      document.getElementById('stat-paid-today').textContent = resp.paid_today || 0;
      document.getElementById('stat-subscribed').textContent = resp.subscribed_now || 0;
      var earnings = parseFloat(resp.total_earnings || 0);
      document.getElementById('stat-earnings').textContent = 'K' + (Number.isInteger(earnings) ? earnings : earnings.toFixed(2));
      // Bar chart
      var chart = document.getElementById('visitors-chart');
      chart.innerHTML = '';
      var max = 1;
      for (var i = 0; i < daily.length; i++) if (daily[i].count > max) max = daily[i].count;
      var dayAbbr = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      for (var j = 0; j < daily.length; j++) {
        var d = daily[j];
        var pct = Math.round((d.count / max) * 100);
        var dayName = dayAbbr[new Date(d.date + 'T00:00:00Z').getUTCDay()];
        var isToday = j === daily.length - 1;
        var col = document.createElement('div');
        col.className = 'bar-col';
        col.innerHTML = '<div class="bar" style="height:' + pct + '%;background:' + (isToday ? '#34a853' : '#1a73e8') + ';"></div>'
          + '<div class="bar-val">' + d.count + '</div>'
          + '<div class="bar-day" style="font-weight:' + (isToday ? '700' : '400') + ';color:' + (isToday ? '#34a853' : '#80868b') + ';">' + dayName + '</div>';
        chart.appendChild(col);
      }
    });
  }

  // --- Settings ---
  function loadSettings() {
    var statusEl = document.getElementById('settings-status');
    statusEl.textContent = 'Loading settings...';
    statusEl.style.color = '#5f6368';
    api('/settings', { action: 'get' }, function(resp) {
      if (!resp.ok) { statusEl.textContent = 'Failed to load settings'; statusEl.style.color = '#ea4335'; return; }
      statusEl.textContent = '';
      var s = resp.settings;
      document.getElementById('set-price').value = s.payment_amount || '';
      document.getElementById('set-days').value = s.sub_days || '';
      document.getElementById('set-words').value = s.free_word_limit || '';
      document.getElementById('set-quizzes').value = s.free_quiz_limit || '';
      document.getElementById('set-phone').value = s.payment_number || '';
    });
  }

  document.getElementById('settings-save').addEventListener('click', function() {
    var btn = this;
    var statusEl = document.getElementById('settings-status');
    var settings = {
      payment_amount: document.getElementById('set-price').value.trim(),
      sub_days: document.getElementById('set-days').value.trim(),
      free_word_limit: document.getElementById('set-words').value.trim(),
      free_quiz_limit: document.getElementById('set-quizzes').value.trim(),
      payment_number: document.getElementById('set-phone').value.trim()
    };

    if (!settings.payment_amount || !settings.sub_days || !settings.free_word_limit || !settings.free_quiz_limit || !settings.payment_number) {
      statusEl.textContent = 'All fields are required';
      statusEl.style.color = '#ea4335';
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Saving...';
    statusEl.textContent = '';

    api('/settings', { action: 'update', settings: settings }, function(resp) {
      btn.disabled = false;
      btn.textContent = 'Save Settings';
      if (resp.ok) {
        statusEl.textContent = 'Settings saved successfully!';
        statusEl.style.color = '#137333';
        showMsg('Settings updated');
      } else {
        statusEl.textContent = resp.error || 'Save failed';
        statusEl.style.color = '#ea4335';
        showMsg(resp.error || 'Save failed', true);
      }
    });
  });

  // Auto-login if token exists
  if (token) {
    showPanel();
  }
})();
</script>
</body>
</html>
